# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

**Please read AGENTS.md for detailed guidelines.** Consider AGENTS.md the comprehensive reference.

## Project Overview

UsuryPay demonstrates the **Expected Cashflow (EC) primitive** - a DeFi primitive for tokenizing future payment streams with default risk. The payroll dApp enables employees to sell future salary for immediate liquidity (factoring, NOT loans).

**Three-actor model:**

- **Employers** - Fund vault, mint EC tokens for employees
- **Employees** - Receive EC tokens, can sell them for immediate cash
- **Usuriers** (UI term for investors/marketplace participants) - Buy EC tokens at discount, manage risk assessment

## Development Commands

```bash
pnpm install          # Install dependencies
pnpm anvil            # Start local Anvil testnet
pnpm deploy:local     # Deploy contracts to Anvil, write deployments.json
pnpm wagmi:generate   # Generate typed React hooks from contract ABIs
pnpm dev              # Dev server (localhost:3000)
pnpm build            # Production build
pnpm lint             # Run ESLint
pnpm format           # Format with Prettier
pnpm format:check     # Check formatting

# Smart contracts (Foundry)
pnpm contracts:build  # Build contracts
pnpm contracts:test   # Run contract tests
forge fmt             # Format Solidity
```

## Local Development Environment

**Network Setup:**
- Local development uses **Anvil** (chainId 31337)
- RPC: `http://127.0.0.1:8545`
- Contracts deployed to Anvil use chainId **31337** in `addresses.ts`

**Environment Detection:**
- `NEXT_PUBLIC_ENV=dev` or undefined → local development mode
- `NEXT_PUBLIC_ENV=prod` → production mode
- On Anvil (chainId 31337), enables contract name mappings (e.g., "usdc.local" → contract address, "anvil1.eth" → test account)

**Why Anvil?**
- Fast local development
- Deterministic test accounts
- Instant transaction confirmations

## ⚠️ CRITICAL: Contract Address Management

### Never Hardcode Contract Addresses

Contract addresses change frequently:
- **Anvil (local)**: New addresses on EVERY `pnpm deploy:local`
- **Testnet/Mainnet**: Change on redeployments
- **Multi-chain**: Different address per chain

**Our Solution**:
1. `deployments.json` - Auto-generated by deploy script (single source of truth)
2. `src/contracts/addresses.ts` - Imports from `deployments.json`
3. `wagmi.config.ts` - Uses `deployments.json` for hook generation

**Result**: Addresses automatically sync across entire stack ✓

### Always Regenerate Hooks After Deployment

**After running `pnpm deploy:local`, you MUST run `pnpm wagmi:generate`**

Why? The wagmi config uses deployed contract addresses from `deployments.json`. When contracts are redeployed (new addresses), the generated hooks need to be updated with those new addresses.

**Development workflow:**
```bash
# Terminal 1
pnpm anvil

# Terminal 2
pnpm deploy:local      # Deploy contracts → updates deployments.json
pnpm wagmi:generate    # ← CRITICAL: Generate hooks with new addresses
pnpm dev               # Start dev server (addresses.ts auto-synced)
```

### Git Tracking Strategy

Following Foundry best practices:
- ✅ **Track** `contracts/broadcast/` for production/testnet deployments
- ❌ **Ignore** `contracts/broadcast/*/31337/` (local anvil only)
- ❌ **Ignore** `src/generated.ts` (regenerated on every deploy)
- ❌ **Ignore** `deployments.json` (local development artifact)

This allows:
- Team visibility into production deployment history
- Foundry deployment tracking on real networks
- No git noise from local development

## Architecture

**Tech Stack:** Next.js 16 (App Router) + React 19 + TypeScript + Tailwind CSS v4 + Wagmi/Viem

**Directory Structure:**

```
src/
├── app/                    # Next.js App Router
│   ├── components/         # Shared components (Header, Providers)
│   ├── employee/           # Employee dashboard route
│   ├── employer/           # Employer dashboard route
│   ├── usurer/             # Investor dashboard route
│   └── WagmiConfig/        # Web3 configuration
└── contracts/              # Solidity contracts (Foundry)

docs/                       # SOURCE OF TRUTH
├── README.md               # Documentation index
├── Primitive.md            # EC primitive specification (CORE)
├── UseCases/Payroll.md     # Payroll implementation
├── Marketplace.md          # EC Marketplace (demo - details TBD)
└── Integrations.md         # Optional integrations
```

## Application Views

Four distinct user interfaces:

- **/employer** - Vault management, token minting, credit monitoring
- **/employee** - View salary tokens, sell to PayrollDApp
- **/usurer** - Portfolio view (your owned EC tokens), NOT marketplace browsing
- **/marketplace** - Browse and buy EC tokens, list tokens for sale

**Key distinction:** Usurer dashboard = portfolio management. Marketplace = token trading.

## Key Terminology

**Use these terms:**

- **EC** (Expected Cashflow) - The primitive
- **ECVault** - Escrow contract where payer deposits funds
- **ECToken** - ERC-721 representing claim rights
- **Factoring** - Selling future cashflows (what we do)
- **Usurer** - UI term for investors/marketplace participants (documentation uses "investor")

**DO NOT use these deprecated terms:**

- ~~RBN~~ (Revenue-Backed Notes)
- ~~CashflowNFT~~
- ~~SettlementManager~~
- ~~Loan/Credit Line~~ (incorrect - it's asset sale)

## Key Development Principles

**Source of Truth:** `docs/` is the absolute authority. Read `docs/README.md` first, then `docs/Primitive.md`.

**Minimalism:** Short code > long code. Fewer comments = faster reading. Less code = fewer bugs.

## Web3 Integration

- Wagmi hooks for wallet connections and contract calls
- Viem for typed contract interactions
- React Query for blockchain data caching
- Reown AppKit for wallet modal (project ID in `.env.local`)
- **Local dev:** Anvil (chainId 31337)
- **Production:** Configured for mainnet and Sepolia testnet

### Wagmi Hook Usage Rule

**RULE**: Always use wagmi-generated hooks directly. Never create custom wrapper hooks.

**Implementation**:

- Import hooks directly from `@/generated`
- For dynamic addresses: `useReadContractName({ address: dynamicAddress, args })`
- For static addresses: `useReadContractName({ args })`
- Generate hooks with: `pnpm wagmi:generate`

**Exceptions**: Complex multi-step business logic only.

## Current State

- Frontend UI implemented with **mock data** - TODOs exist for Web3 integration
- Smart contracts scaffolded but **not yet implemented**
- No test framework configured (Vitest + Playwright recommended)
- Protocol integrations (ENS, Arc, Yellow) are optional enhancements
